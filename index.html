<!DOCTYPE html>
<html>
 <head>
  <title>cool ∅</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5.3.2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <!-- jQuery 3.7.0 -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <!-- Fontawesome 6.4.0 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- typed.js 2.0.16 -->
  <script src="https://unpkg.com/typed.js@2.0.16/dist/typed.umd.js"></script>
  <!-- html2canvas 1.4.1 -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <!-- Customize -->
  <link rel="stylesheet" href="./css/profile.css" />
  <script src="./js/profile.js"></script>
  <script>

	let profile = new Profile({
		files: {
			"about_me": "https://cool-void-zero.github.io/json/about_me.json", 
			"portfolio": "https://cool-void-zero.github.io/json/portfolio.json", 
			"contact": "https://cool-void-zero.github.io/json/contact.json", 
		}, 
		active_index: 0, 
		typing_mode: false, 
		design_mode: false, 
	});
	
	//	when mousedown the filename
	function handleFileClick({ profile, filename }){
		//	clear html content
		$("#filename").html("");
		$(`#file-content-${filename}`).html("");

		//	hidden all the typed cursor blink
		$(".typed-cursor").addClass("d-none");

		//	remove all "vs-file-active" class from "profile.files"
		for(const section in profile.files)
			$(`#file-${section}`).removeClass("vs-file-active");
		//	add "vs-file-active" class to current "this" element
		$(`#file-${filename}`).addClass("vs-file-active");

		//	add all "d-none" class to "profile.files"
		for(const section in profile.files)
			$(`#file-content-${section}`).addClass("d-none");
		//	remove "d-none" class to current "this" element
		$(`#file-content-${filename}`).removeClass("d-none");
		
		let new_index = profile.checkActiveIndex(filename);
		
		//	if the new_index not exist, default show latest file
		if(new_index === -1){
			new_index = profile.getActiveIndex();
			filename = profile.getActiveSection(new_index);
		}
		
		profile.setActiveIndex(new_index);
		profile.activeSection(filename);
	}

	//	when dragging the filename
	function handleFileMoving({ profile, files_id, this_id }){
		//	get the moving position index
		const getPositionIndex = (moving_x, files_position = []) => {
			let index = 0;
			
			for(let i=0; i<files_position.length; i++){
				const { mid } = files_position[i];

				if(moving_x > mid)
					index = i + 1;
			}

			return index;
		}
		
		function mouseMoveHandler(e){
			if(profile.getIsClosingFile()) return;
			console.log(`moving...`);

			const { clientX: moving_x, clientY: moving_y } = e;
			const id_list = profile.files_id.map(id => `#${id}`).join(',');
			const files_position = profile.files_id.map(id => {
				const { 
					x, y, width, height, 
				} = document.getElementById(id).getBoundingClientRect();
				const mid = x + width / 2;
				
				return {
					x, y, mid, 
					width, height, 
				}
			});
			const position_index = getPositionIndex(moving_x, files_position);
			target_index = position_index - 1;

			$("#draggable").css({
				display: `block`, 
				top: `${moving_y}px`, 
				left: `${moving_x}px`, 
			});
			//	reset all the border 
			$(id_list).css({
				borderLeft: ``, 
				borderRight: ``,  
			})
			
			if(position_index === 0)
				$(`#${profile.files_id[0]}`).css({
					borderLeft: `1px solid white`, 
				});
			else
				$(`#${profile.files_id[target_index]}`).css({
					borderRight: `1px solid white`, 
				});
		}

		function mouseUpHandler(){
			const id_list = profile.files_id.map(id => `#${id}`).join(',');

			//	reset all the border 
			$(id_list).css({
				borderLeft: ``, 
				borderRight: ``,  
			})
			$("#draggable").css("display", "none");

			//	after switch position (change index of "profile.files_id")
			profile.switchPosition({
				source: selected_index, 
				target: target_index, 
			});
			//	rebuild file-path (sorting)
			const html_contents = profile.files_id.map(id => 
				document.getElementById(id).outerHTML
			);
			$(`#vs-file-path`).html(html_contents.join(""));

			//	re-bind the filenames clicked effect (switchPosition will rebuild the html element)
			$(id_list).unbind("click");
			$(id_list).unbind("mousedown");
			$(".fa-xmark").unbind("mousedown");
			$(".fa-xmark").unbind("mouseup");
			
			//	Similar close file
			$(".fa-xmark").bind("mousedown", handleCloseFile);
			//	Similar files selected, dragging, switch position effect
			$(id_list).bind("mousedown", function(){
				handleFileMoving({
					profile, files_id, 
					this_id: this.id, 
				}); 
			});

			document.removeEventListener("mousemove", mouseMoveHandler);
			document.removeEventListener("mouseup", mouseUpHandler);
		}

		if(profile.getIsClosingFile()) return;

		const filename = this_id.substring(this_id.indexOf('-') + 1);
		handleFileClick({ profile, filename });
		
		//	selected files index and moving target index position of "profile.files_id"
		const selected_index = profile.files_id.indexOf(this_id);
		let target_index = selected_index;
		const { left, top } = document.getElementById(this_id).getBoundingClientRect();

		$("#draggable").html($(`#${this_id}`).html());
		$("#draggable").css({
			top: `${top}px`, 
			left: `${left + 5}px`, 
		});
		
		document.addEventListener("mousemove", mouseMoveHandler);
		document.addEventListener("mouseup", mouseUpHandler);
	}

	function handleOpenFile(event){
		const generateFilePathElement = (filename, is_active = true) => {
			const id = `file-${filename}`;
			const active_class = (is_active)? " vs-file-active ": "";
			const file_path_element = `
                <span id="${id}" class="col-auto vs-file ${active_class}">
                    <span class="ms-2 me-1 json-yellow">{ }</span>
                    <span class="text-light">${filename}.json</span>
                    <span class="ms-2 text-light">
                        <i class="fa-solid fa-xmark"></i>
                    </span>
                </span>
            `;
			
			return file_path_element;
		}

		const file = event.target.files[0];
		//	remove the ".json" extension 
		let filename = file?.name || "";
		filename = (filename)? filename.substring(0, filename.indexOf('.')): "";

		if(file && filename && file.type === "application/json"){
			const reader = new FileReader();

			reader.onload = function(e){
				try{
					const json_str = e.target.result;
					const json = JSON.parse(json_str);
					const base64 = btoa(json_str);
					const data_url = `data:application/json;base64,${base64}`;
					const file_path_element = generateFilePathElement(filename);
					const json_content_element = profile.buildTypedElement(json).trim();
					
					profile.files[filename] = data_url;
					profile.files_id.push(`file-${filename}`);
					profile.json_content[filename] = json_content_element;
					
					//	Append new file content 
					$("#vs-file-path").append(file_path_element);
					$("#file-content").append(`
						<div id="file-content-${filename}">${json_content_element}</div>
					`.trim());
					$(`#file-${filename}`).bind("mousedown", function(){
						handleFileMoving({
							profile, this_id: this.id, 
						}); 
					});
					
					//	Default open a new file will hidden blank page 
					$(`#vs-page`).removeClass("d-none");
					$(`#closed-page`).removeClass("d-flex");
					$(`#closed-page`).addClass("d-none");

					profile.setActiveIndex(profile.files_id.length - 1);
					handleFileClick({ profile, filename: profile.getActiveSection() });
				}
				catch(error){
					console.error(error);
					console.log(`Fail to parsing JSON content.`);
				}
			};

			reader.readAsText(file);
		}
		else
			console.log(`Please upload a valid JSON file.`);
	}

	function handleCloseFile(){
		profile.setIsClosingFile(true);

		const id = this.parentElement.parentElement.id;
		const filename = id.substring(id.lastIndexOf('-') + 1);
		const index = profile.checkActiveIndex(filename);
		
		//	remove the close file element ("#file-xxx" and "#file-content-xxx")
		$(`#file-${filename}`).remove();
		$(`#file-content-${filename}`).remove();
		
		profile.closeFile(filename);

		//	already closed all files
		if(profile.files_id.length === 0){
			$(`#vs-page`).addClass("d-none");
			$(`#closed-page`).addClass("d-flex");
			$(`#closed-page`).removeClass("d-none");
		}
		else
			handleFileClick({ profile, filename: profile.getActiveSection() });

		profile.setIsClosingFile(false);
	}

	$(async() => {
		try{
			//	generate require elements and loading with typing effect
			await profile.initiate();
			profile.activeSection(profile.getActiveSection(), profile.typing_mode);
		}catch(error){
			const err_msg = `Fail to initiate profile.`;

			console.error(error);
			console.log(`[Document Ready] ${err_msg}`);
			alert(err_msg);
		}

		//	Switch Typing Effect
		$("#switch-typing-effect").bind("change", () => {
			typing_mode = document.querySelector("#switch-typing-effect").checked;
			profile.setTypingMode(typing_mode);
		});

		//	When click the command or press Ctrl + O keyboard
		$(".ctrl-o").bind("click", () => $("#input-json-file").click());
		$(document).bind("keydown", function(event){
			//	Ctrl + O
			const is_press_open = (event.ctrlKey && event.keyCode === 79);

			if(is_press_open){
				$("#input-json-file").click();

				//	Don't execute default behavior
				return false;
			}
		});

		//	Similar open a new json file
		$("#input-json-file").bind("change", handleOpenFile);

		//	Similar Close File
		$(".fa-xmark").bind("mousedown", handleCloseFile);
		
		const files_id = Object.keys(profile.files).map(key => `#file-${key}`).join(", ");
		//	Similar files selected, dragging, switch position effect
		$(files_id).bind("mousedown", function(e){
			handleFileMoving({
				profile, files_id, 
				this_id: this.id, 
			}); 
		});

		//	based on profile setting enable the design mode
		if(profile.design_mode)
			document.designMode = "on";
	});

  </script>
 </head>
 <body class="text-light">
  
  <!-- Container -->
  <div class="d-flex h-100 p-3">
	<!-- Page: VS Code -->
   <div id="vs-page">
	<!-- Top Menu Bar (VS Code - Filename & Path) -->
	<div id="vs-file-path" class="row w-100 m-0"></div>
	
	<!-- VS Code - Full Path -->
	<div id="vs-path" class="text-secondary ms-2 pt-2 pb-1">
	 C: > cool ∅ > <span class="json-yellow">{ }</span> 
	 <span id="filename"></span>
	</div>
	<!-- End of VS Code - Full Path -->

	<!-- JSON File Content (will generate children element) -->
	<div id="file-content"></div>
	<!-- Canvas for preview codes on right site -->
	<div id="canvas-content" class="d-none d-md-flex"></div>

	<!-- Typing Effect Switch -->
	<div class="position-absolute d-none d-md-flex p-3 top-0 end-0">
	 <div class="form-check form-switch">
	  <input class="form-check-input" id="switch-typing-effect" type="checkbox" role="switch" />
	  <label class="form-check-label" for="switch-typing-effect">Typing Effect</label>
	 </div>
	</div>
	<!-- End of Typing Effect Switch -->
   </div>
   <!-- End of Page: VS Code -->

   <!-- Page: Closed All Files -->
   <div id="closed-page" class="d-none flex-column w-100 h-100 align-items-center justify-content-center">
    <img src="./images/vs-code-logo-dark.png" title="A image of VS Code Logo" />
    <!-- Row: Show All Commands -->
    <div class="row mt-4 mb-space">
     <div class="col p-0 text-end closed-file-text">
      Show All Commands
     </div>
     <div class="col closed-file-command">
      <span class="keyboard">Ctrl</span> + <span class="keyboard">Shift</span> + <span class="keyboard">P</span>
     </div>
    </div>

    <!-- Row: Open File -->
    <div class="row mb-space">
     <div class="col p-0 text-end closed-file-text">
      Open File
     </div>
     <div class="col closed-file-command ctrl-o">
      <span class="keyboard">Ctrl</span> + <span class="keyboard">O</span>
     </div>
    </div>

    <!-- Row: Open Folder -->
    <div class="row mb-space">
     <div class="col p-0 text-end closed-file-text">
      Open Folder
     </div>
     <div class="col closed-file-command">
      <span class="keyboard">Ctrl</span> + <span class="keyboard">K</span> 
      <span class="mx-1"></span>
	  <span class="ctrl-o">
       <span class="keyboard">Ctrl</span> + <span class="keyboard">O</span> 
	  </span>
     </div>
    </div>
     
    <!-- Row: Open Recent -->
    <div class="row mb-space">
     <div class="col p-0 text-end closed-file-text">
      Open Recent
     </div>
     <div class="col closed-file-command">
      <span class="keyboard">Ctrl</span> + <span class="keyboard">R</span> 
     </div>
    </div>
   </div>
   <!-- End of Page: Closed All Files -->
   
   <!-- Drag Element -->
   <div id="draggable" class="vs-file-active"></div>

   <!-- Open JSON File -->
	<input id="input-json-file" class="d-none" type="file" accept=".json" />
  </div>
  <!-- End of Container -->

 </body>
</html>